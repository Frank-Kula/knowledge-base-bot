# 快速启动指南

## 📋 前置检查清单

在开始之前，请确保已准备好：

- [ ] **Python 3.9+** 已安装
- [ ] **LLM API Key**（Claude/DeepSeek/OpenAI）
- [ ] **飞书开放平台账号**
- [ ] **Apifox 帮助文档**（或使用爬虫自动获取）

## 🚀 5 分钟快速启动

### 步骤 1：安装依赖

```bash
# 进入项目目录
cd knowledge-base-bot

# 创建虚拟环境（推荐）
python -m venv venv

# 激活虚拟环境
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

### 步骤 2：配置环境变量

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件，至少填写以下内容：
```

**必需的配置**：
```env
# LLM API（选择一个）
LLM_API_KEY=your-api-key-here

# 飞书应用
FEISHU_APP_ID=cli_xxxxxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxxxxxx

# 飞书多维表格
FEISHU_APP_TOKEN=your-app-token
FEISHU_TABLE_ID=your-table-id
```

### 步骤 3：准备文档

```bash
# 使用爬虫自动获取 Apifox 文档（推荐）
python src/rag/crawl_apifox_docs.py

# 或手动将 Markdown 文档放入 data/documents/ 目录
```

### 步骤 4：构建知识库

```bash
python src/rag/knowledge_base.py
```

预期输出：
```
2025-01-15 10:00:00 | INFO | 开始构建知识库...
2025-01-15 10:00:05 | INFO | 加载了 50 个文档
2025-01-15 10:00:10 | INFO | 分割为 500 个片段
2025-01-15 10:00:30 | INFO | 向量数据库创建完成
```

### 步骤 5：测试知识库

```bash
# 创建测试脚本 test_kb.py
```

```python
# test_kb.py
import asyncio
from src.rag.knowledge_base import KnowledgeBase
from src.utils.config_loader import load_config

async def test():
    config = load_config()
    kb = KnowledgeBase(config)
    await kb.initialize()

    # 测试搜索
    results = await kb.search("如何发送接口请求")
    print(f"找到 {len(results)} 个相关文档\n")

    for i, doc in enumerate(results, 1):
        print(f"文档 {i}:")
        print(doc.page_content[:200])
        print("---\n")

asyncio.run(test())
```

运行测试：
```bash
python test_kb.py
```

### 步骤 6：配置飞书

#### 6.1 创建飞书应用
1. 访问 https://open.feishu.cn/app
2. 点击"创建企业自建应用"
3. 填写应用信息：
   - 应用名称：`技术支持机器人`
   - 应用描述：`自动收集用户问题并分类`

#### 6.2 开启权限
在"权限管理"中开启：
- `im:message` - 发送消息
- `im:message:group_at_msg` - 接收群消息
- `bitable:app` - 多维表格读写

#### 6.3 创建多维表格

**缺陷记录表**字段：
| 字段名 | 类型 | 说明 |
|--------|------|------|
| 标题 | 文本 | 缺陷标题 |
| 类型 | 单选 | 缺陷/需求/使用咨询 |
| 优先级 | 单选 | P0/P1/P2/P3 |
| 版本 | 文本 | Apifox 版本号 |
| 环境 | 文本 | Web端/客户端 |
| 复现步骤 | 多行文本 | 1-2-3-4 步骤 |
| 预期结果 | 多行文本 | 预期行为 |
| 实际结果 | 多行文本 | 实际行为 |
| 是否必现 | 单选 | 总是/偶发/仅一次 |
| 补充信息 | 多行文本 | 截图/日志等 |
| 提交人 | 人员 | 创建人 |
| 创建时间 | 日期 | 自动生成 |

#### 6.4 获取凭证

从 URL 中获取：
- `app_token`：`/base/` 后面的字符串
- `table_id`：`/table/` 后面的字符串

#### 6.5 配置事件订阅

请求 URL：`https://your-domain.com/webhook/feishu`

订阅事件：`im.message.receive_v1`

### 步骤 7：启动服务

```bash
# 本地测试
python src/bots/main.py

# 服务将在 http://localhost:8000 运行
```

预期输出：
```
2025-01-15 10:00:00 | INFO | 技术支持知识库机器人启动中...
2025-01-15 10:00:05 | INFO | 向量数据库加载成功，文档数: 500
2025-01-15 10:00:06 | INFO | 机器人启动完成，监听端口: 8000
```

### 步骤 8：测试机器人

在飞书群中发送测试消息：
```
接口测试失败了怎么办？
```

机器人应该：
1. 确认收到问题
2. 询问版本号
3. 询问环境信息
4. 收集复现步骤
5. 分析并分类
6. 生成工单

## 🔧 使用 ngrok 测试（开发环境）

如果本地测试，使用 ngrok 暴露本地服务：

```bash
# 1. 安装 ngrok
# 下载地址: https://ngrok.com/download

# 2. 启动 ngrok
ngrok http 8000

# 3. 复制生成的 URL
# 例如: https://abc123.ngrok.io

# 4. 在飞书事件订阅中使用
# URL: https://abc123.ngrok.io/webhook/feishu
```

## 📊 验证检查清单

启动后，验证以下功能：

- [ ] 服务正常启动（无报错）
- [ ] 飞书 Webhook 能接收消息
- [ ] 机器人能回复消息
- [ ] 信息收集流程正常
- [ ] 知识库检索有结果
- [ ] 问题分类准确（测试几个案例）
- [ ] 飞书工单能创建
- [ ] 多维表格有新记录

## ⚠️ 常见问题排查

### 问题 1：导入错误 `No module named 'xxx'`

**解决**：
```bash
# 确保激活了虚拟环境
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# 重新安装依赖
pip install -r requirements.txt
```

### 问题 2：向量数据库构建失败

**原因**：文档目录为空或格式不对

**解决**：
```bash
# 检查文档是否存在
ls data/documents/

# 确保是 .md 格式
# 如果为空，运行爬虫
python src/rag/crawl_apifox_docs.py
```

### 问题 3：飞书机器人无响应

**检查**：
1. 飞书应用权限是否开启
2. 事件订阅 URL 是否可访问
3. 查看日志 `tail -f logs/bot.log`
4. 确认 .env 配置正确

### 问题 4：分类不准确

**优化**：
1. 增加文档数量（至少 20 篇）
2. 调整 `config/config.yaml` 中的 Prompt
3. 尝试不同的 LLM（Claude > DeepSeek > GPT-3.5）
4. 收集错误案例，人工审核后优化

### 问题 5：飞书工单创建失败

**检查**：
1. `app_token` 和 `table_id` 是否正确
2. 应用是否有 `bitable:app` 权限
3. 字段映射是否匹配（飞书字段名 vs 配置文件）

## 📈 下一步优化

完成基础配置后，可以：

1. **自定义 Prompt**
   - 编辑 `config/config.yaml`
   - 根据实际情况调整分类标准

2. **添加更多文档**
   - 爬取或手动添加
   - 重建知识库

3. **优化交互话术**
   - 编辑机器人回复模板
   - 让对话更自然

4. **配置监控**
   - 添加日志分析
   - 监控分类准确度

5. **成本优化**
   - 使用 DeepSeek
   - 启用缓存
   - 使用 Serverless

## 🆘 需要帮助？

查看详细文档：
- [前置准备](./docs/前置准备.md)
- [工作流程示例](./docs/工作流程示例.md)
- [实施计划](./docs/实施计划.md)

查看日志：
```bash
tail -f logs/bot.log
```

测试配置：
```bash
python -c "from src.utils.config_loader import load_config; print(load_config())"
```

## 🎉 完成！

恭喜！你的技术支持机器人已经启动。现在可以在用户群中开始使用了。

记得：
- ✅ 先小范围测试
- ✅ 收集反馈优化
- ✅ 保留人工审核
- ✅ 持续改进 Prompt

祝使用愉快！🚀

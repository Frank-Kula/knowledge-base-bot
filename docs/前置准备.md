# 技术支持机器人 - 前置准备指南

## 一、必需资源准备

### 1. LLM API 密钥（选择一个）

#### 选项 A: Anthropic Claude（推荐）
- 访问 https://console.anthropic.com/
- 注册账号并创建 API Key
- 充值（建议先充值 $5 测试）
- 优点：中文理解好，分类准确度高

#### 选项 B: OpenAI GPT-4
- 访问 https://platform.openai.com/
- 注册并创建 API Key
- 充值（建议先充值 $5 测试）
- 优点：响应快，成本低

#### 选项 C: DeepSeek（国产，性价比高）
- 访问 https://platform.deepseek.com/
- 注册并创建 API Key
- 优点：便宜，中文支持好

**选择建议**：优先使用 Claude，其次是 DeepSeek

### 2. 飞书开放平台配置

#### 2.1 创建企业自建应用
1. 访问 https://open.feishu.cn/app
2. 点击"创建企业自建应用"
3. 填写应用信息：
   - 应用名称：技术支持机器人
   - 应用描述：用户问题收集和分类

#### 2.2 开启机器人能力
1. 在应用管理页面，找到"权限管理"
2. 开启以下权限：
   - `im:message` - 发送消息
   - `im:message:group_at_msg` - 接收群消息
   - `bitable:app` - 多维表格读写权限

#### 2.3 获取凭证
1. 在"凭证与基础信息"页面获取：
   - App ID
   - App Secret
2. 在"事件订阅"页面获取：
   - Encrypt Key
   - Verification Token

#### 2.4 配置事件订阅
1. 设置请求 URL：`https://your-domain.com/webhook/feishu`
2. 订阅事件：
   - `im.message.receive_v1` - 接收消息

#### 2.5 发布应用
1. 在"版本管理与发布"中创建版本
2. 发布到指定团队或全员

### 3. 飞书多维表格准备

#### 3.1 创建多维表格
1. 在飞书中创建"多维表格"
2. 创建"Bug 缺陷表"，字段：
   - 标题（文本）
   - 类型（单选：缺陷/需求/使用咨询）
   - 优先级（单选：P0/P1/P2/P3）
   - 版本（文本）
   - 环境（文本）
   - 问题描述（多行文本）
   - 复现步骤（多行文本）
   - 预期结果（多行文本）
   - 实际结果（多行文本）
   - 提交人（人员）
   - 创建时间（日期）

#### 3.2 获取表格 Token
1. 打开多维表格
2. 从 URL 中获取：
   - `app_token`：`/base/` 后面的字符串
   - `table_id`：`/table/` 后面的字符串

### 4. 企业微信机器人（可选）

#### 4.1 创建群机器人
1. 在企微群中，点击群设置 → 群机器人
2. 添加机器人 → 新建机器人
3. 设置机器人名称和头像
4. 获取 Webhook URL

**注意**：企微机器人功能有限，只能发送消息，无法接收消息。如果需要双向交互，建议使用飞书。

## 二、文档准备

### 1. 导出 Apifox 帮助文档

#### 方法 A: 使用爬虫（推荐）
```bash
cd src/rag
python crawl_apifox_docs.py
```

#### 方法 B: 手动导出
1. 访问 https://docs.apifox.com/
2. 逐个页面复制内容
3. 保存为 Markdown 文件到 `data/documents/`

### 2. 文档目录结构
```
data/documents/
├── apifox/
│   ├── 入门/
│   │   ├── 介绍.md
│   │   ├── 快速上手.md
│   │   └── ...
│   ├── 发送请求/
│   ├── 设计API/
│   ├── 调试API/
│   └── ...
```

## 三、服务器准备

### 选项 A: 本地开发
- Python 3.9+
- 至少 4GB 内存
- 稳定网络环境

### 选项 B: 云服务器（推荐）
- 阿里云/腾讯云 2核4G
- 安装 Docker（可选）
- 配置域名和 SSL 证书

### 选项 C: Serverless（最省事）
- 使用阿里云函数计算 / 腾讯云 SCF
- 按量计费，成本低

## 四、部署步骤

### 1. 克隆项目
```bash
git clone <your-repo-url>
cd knowledge-base-bot
```

### 2. 安装依赖
```bash
# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

### 3. 配置环境变量
```bash
cp .env.example .env
# 编辑 .env 文件，填写实际的 API Key 和配置
```

### 4. 准备文档
```bash
# 爬取或放置帮助文档到 data/documents/
# 确保文档是 .md 格式
```

### 5. 构建知识库
```bash
python src/rag/knowledge_base.py
```

### 6. 启动机器人
```bash
python src/bots/main.py
```

### 7. 测试
在飞书/企微群中发送测试消息：
```
接口测试失败怎么办？
```

## 五、配置检查清单

部署前请确认：

- [ ] LLM API Key 已配置
- [ ] 飞书应用已创建并发布
- [ ] 飞书多维表格已创建
- [ ] 飞书事件订阅已配置
- [ ] 帮助文档已准备（至少 10 篇）
- [ ] 知识库已构建
- [ ] Webhook URL 可访问
- [ ] 防火墙端口 8000 已开放

## 六、常见问题

### Q1: 飞书机器人收不到消息？
**A**:
1. 检查应用权限是否开启
2. 检查事件订阅是否成功
3. 检查 Webhook URL 是否可访问

### Q2: 知识库检索结果不准确？
**A**:
1. 增加文档数量（至少 20 篇）
2. 调整 `chunk_size` 和 `chunk_overlap`
3. 优化 Prompt 模板

### Q3: 分类置信度低？
**A**:
1. 收集更多历史数据
2. 微调分类 Prompt
3. 使用更强大的 LLM（如 GPT-4）

### Q4: 飞书多维表格写入失败？
**A**:
1. 检查 `app_token` 和 `table_id` 是否正确
2. 检查应用是否有 `bitable:app` 权限
3. 检查字段映射是否匹配

## 七、成本估算

### 月度成本（1000 次提问）

| 项目 | 成本 |
|------|------|
| LLM API (Claude) | ~$5-10 |
| 飞书开放平台 | 免费 |
| 云服务器 | ~￥30/月 |
| 域名+SSL | ~￥50/年 |
| **总计** | ~￥80-100/月 |

### 优化建议
1. 使用 DeepSeek 替代 Claude（成本降低 70%）
2. 使用 Serverless（无需服务器成本）
3. 缓存常见问题（减少 LLM 调用）

## 八、下一步

1. **准备文档**：爬取或导出 Apifox 帮助文档
2. **配置飞书**：创建应用和多维表格
3. **本地测试**：先在本地运行测试
4. **部署上线**：部署到云服务器
5. **监控优化**：收集数据，持续优化

需要帮助？查看：
- [部署详细指南](./部署指南.md)
- [API 文档](./API文档.md)
- [常见问题](./常见问题.md)

# 文档自动更新方案

## 方案对比

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|---------|
| **定时任务** | 简单可靠，易于控制 | 需要服务器持续运行 | 有服务器环境 |
| **GitHub Actions** | 完全免费，无需服务器 | 需要 GitHub 仓库 | 开源项目或使用 Git |
| **本地调度器** | 灵活可控 | 需要本地持续运行 | 开发测试环境 |
| **手动触发** | 简单直接 | 容易忘记 | 临时更新 |

## 方案 1: 系统定时任务（推荐生产环境）

### Linux/Mac (Cron)

```bash
# 编辑 crontab
crontab -e

# 添加定时任务（每天凌晨 2 点执行）
0 2 * * * cd /path/to/knowledge-base-bot && ./update_docs.sh
```

### Windows (任务计划程序)

```powershell
# 打开任务计划程序
# 创建基本任务
# 设置触发器：每天 02:00
# 设置操作：运行 update_docs.bat
```

## 方案 2: GitHub Actions（推荐免费方案）

### 优点
- ✅ 完全免费
- ✅ 无需服务器
- ✅ 自动记录历史
- ✅ 支持手动触发

### 设置步骤

1. **创建 GitHub 仓库**
   ```bash
   git init
   git add .
   git commit -m "Initial commit"
   git remote add origin https://github.com/your-username/knowledge-base-bot.git
   git push -u origin main
   ```

2. **启用 GitHub Actions**
   - 代码已包含 `.github/workflows/update-docs.yml`
   - 推送到 GitHub 后自动启用

3. **查看执行记录**
   - 访问：`https://github.com/your-username/knowledge-base-bot/actions`
   - 可以看到每次更新的详细日志

4. **手动触发更新**
   - 在 Actions 页面
   - 选择 "Update Apifox Docs"
   - 点击 "Run workflow"

### 调整更新频率

编辑 `.github/workflows/update-docs.yml`：

```yaml
# 每天凌晨 2 点
schedule:
  - cron: '0 2 * * *'

# 每 6 小时
# schedule:
#   - cron: '0 */6 * * *'

# 每周日凌晨 3 点
# schedule:
#   - cron: '0 3 * * 0'
```

## 方案 3: 内置调度器

### 使用调度器持续运行

```bash
# 启动调度器（持续运行）
python src/rag/update_scheduler.py --mode scheduler
```

### 使用 systemd（Linux）

创建服务文件 `/etc/systemd/system/docs-updater.service`：

```ini
[Unit]
Description=Apifox Docs Updater
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/knowledge-base-bot
ExecStart=/path/to/venv/bin/python src/rag/update_scheduler.py --mode scheduler
Restart=always

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable docs-updater
sudo systemctl start docs-updater

# 查看状态
sudo systemctl status docs-updater

# 查看日志
sudo journalctl -u docs-updater -f
```

## 方案 4: 手动更新

### 检查更新（不修改文件）

```bash
# 检查哪些页面有更新
python src/rag/auto_update_docs.py --mode check
```

输出示例：
```
更新统计:
  总计: 50
  新增: 3
  更新: 5
  未变: 42
  删除: 0
  失败: 0
```

### 智能更新（只更新有变化的）

```bash
# 检查并更新，如果有变化则重建知识库
python src/rag/auto_update_docs.py --mode smart --rebuild-kb
```

### 强制全量更新

```bash
# 删除所有文档，重新爬取
python src/rag/auto_update_docs.py --mode full --rebuild-kb
```

## 更新策略对比

| 策略 | 命令 | 速度 | 准确性 | 推荐场景 |
|------|------|------|--------|---------|
| **检查模式** | `--mode check` | 快 | 只检查，不修改 | 查看更新情况 |
| **智能模式** | `--mode smart` | 中等 | 高，按需更新 | 日常使用（推荐） |
| **全量模式** | `--mode full` | 慢 | 最高，完整更新 | 首次或大量更新 |

## 更新频率建议

### 高频更新（活跃项目）
- **频率**：每天 1 次
- **时间**：凌晨 2-4 点
- **方式**：智能更新

### 中频更新（稳定项目）
- **频率**：每周 1-2 次
- **时间**：周日凌晨
- **方式**：智能更新

### 低频更新（很少变化）
- **频率**：每月 1 次
- **时间**：月初
- **方式**：全量更新

## 增量更新原理

### 元数据追踪

每次爬取后会创建 `.metadata.json`：

```json
{
  "last_update": "2025-01-15T10:30:00",
  "pages": {
    "https://docs.apifox.com/xxx": {
      "hash": "abc123...",
      "last_update": "2025-01-15T10:30:00",
      "file": "页面标题.md"
    }
  }
}
```

### 更新检测流程

1. 计算当前页面内容的 MD5 哈希
2. 与元数据中记录的哈希对比
3. 如果不同，说明页面有更新
4. 只更新变化的页面
5. 如果变化超过 10 个页面，建议全量更新

## 监控和日志

### 查看更新日志

```bash
# 查看最近的更新记录
tail -f logs/update.log

# 查看机器人日志
tail -f logs/bot.log
```

### 设置更新通知

创建通知脚本 `notify_update.sh`：

```bash
#!/bin/bash

# 更新后发送通知
python src/rag/auto_update_docs.py --mode smart

if [ $? -eq 0 ]; then
    # 发送到飞书
    curl -X POST "https://open.feishu.cn/open-apis/bot/v2/hook/xxx" \
      -H "Content-Type: application/json" \
      -d '{"msg_type":"text","content":{"text":"✅ Apifox 文档已更新"}}'

    # 或发送邮件
    echo "文档已更新" | mail -s "更新通知" your@email.com
fi
```

## 最佳实践

### 1. 定期检查更新
```bash
# 每周检查一次更新情况
python src/rag/auto_update_docs.py --mode check
```

### 2. 变化大时全量更新
```bash
# 如果检查到大量更新（>10个页面），使用全量更新
python src/rag/auto_update_docs.py --mode full
```

### 3. 更新后重建知识库
```bash
# 确保知识库使用最新文档
python src/rag/auto_update_docs.py --mode smart --rebuild-kb
```

### 4. 备份重要版本
```bash
# 在全量更新前备份
cp -r data/documents/apifox data/documents/apifox_backup_$(date +%Y%m%d)
```

## 故障处理

### 爬取失败

**问题**：网络错误或页面结构变化

**解决**：
```bash
# 重试
python src/rag/auto_update_docs.py --mode smart

# 如果持续失败，全量更新
python src/rag/auto_update_docs.py --mode full
```

### 知识库重建失败

**问题**：向量数据库损坏

**解决**：
```bash
# 删除并重建
rm -rf data/vectordb
python src/rag/knowledge_base.py
```

### 定时任务不执行

**检查**：
```bash
# Linux/Mac: 检查 cron 日志
grep CRON /var/log/syslog

# Windows: 查看任务计划程序历史
# 在任务计划程序中查看历史记录
```

## 推荐方案

### 生产环境
**系统定时任务 + 智能更新**
- 每天凌晨 2 点
- 使用 crontab 或任务计划程序
- 自动重建知识库

### 开发环境
**手动触发**
- 需要时手动运行
- 使用智能模式
- 查看更新日志

### CI/CD 环境
**GitHub Actions**
- 完全免费
- 无需服务器
- 自动记录历史

## 下一步

1. **选择方案**：根据环境选择合适的更新方案
2. **测试更新**：先手动测试一次完整流程
3. **设置定时**：配置定时任务
4. **监控日志**：确保更新正常运行
5. **定期检查**：每周检查更新日志

选择最适合你的方案，确保文档始终保持最新！🚀
